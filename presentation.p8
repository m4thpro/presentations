pico-8 cartridge // http://www.pico-8.com
version 8
__lua__
-- px8 by zep
-- gfx,sfx,map compression

-- compression parameters
p={}
p.cbits  = 1   -- max:7
p.remap = true

-----------------------------
-- decompression
-----------------------------

function remap(i,w,h)
 local sx=flr((i/64)%(w/8))
 local sy=flr((i/64)/(w/8))
 local x=(i%8)
 local y=flr(flr(i%64)/8)
 return (sx*8+x)+(sy*8+y)*w
end

function decomp(src, px,py,xget,xset)

 local pn={}
 src-=1 
 local bit=256
 local b=0
 
 function getval(bits)
  val=0
  for i=0,bits-1 do

   --get next bit from stream
   if (bit==256) then
    bit=1
    src+=1
    byte=peek(src)
   end
   if band(byte,bit)>0 then
    val+=shl(1,i)
   end
   bit*=2
   
  end
  return val
 end
 
 -- read header
 
 local w = getval(8)
 local h = getval(8)
 local cbits = getval(3)
 local rmp = getval(1) 
 local maxci = getval(8)
 local bpp = getval(3)+1
 local clist={}
 for i=0,maxci do
  clist[i]=getval(bpp)
 end
 
 -- spans
 
 local i = 0
 local span = 0
 
 while (i < w*h) do

  -- span length 
  local bl = 1
  while getval(1)==0 do
   bl += 1 end
  
  local minv=shl(1,bl-1)
  if (bl==1) minv=0
  
  local len=
   getval(max(1,bl-1))+minv+1

  for j=0,len-1 do
  
   local i1 = i
   
   if (rmp==1) i1=remap(i,w,h)
   
   x = px+(i1)%w
   y = py+flr(i1/w)
   
   -- predict colour
   
   local t=xget(x+0,y-1)/16
   local l=xget(x-1,y+0)*16
   if (y==py) t=0
   if (x==px) l=0
   
   pc=pn[t+l] or pn[t] or pn[l]
   
   if (span%2 == 0) then
    -- raw literal
    
    local index=0
    
    repeat
     v=getval(cbits)
     index += v
    until (v < shl(1,cbits)-1)
    
    local pindex=999
    for i=0,maxci do
     if (pc==clist[i]) pindex=i
    end
    
    if (pindex <= index) index+=1
    
    col = clist[index]
    
    -- move to front
    for i=index,1,-1 do
     clist[i]=clist[i-1]
    end
    clist[0] = col
    
   else
    -- predicted

    col = pc
    
   end
   
   xset(x,y,col)
      
   -- adjust predictions
   
   pn[t]=col
   pn[l]=col
   pn[t+l]=col
   
   i += 1
  end
  span += 1
  
 end
 
end

pset(64,64,2)
decomp(0x0000,0,0, pget, pset)
while(btn()==0) do end

decomp(0x0800,0,0, pget, pset)
while(btn()==0) do end

decomp(0x1000,0,0, pget, pset)
while(btn()==0) do end

decomp(0x1800,0,0, pget, pset)
while(btn()==0) do end

__gfx__
0808970382bb04290004742b4443886d88a5c4d6623d283a1eafb4a937babbb5e22506d73af92a3074771fe06e73504bebb28f201d0210e2f410fbf9f08651e1
0bd0b9ef5daa043147ab0ceced7f1308005d9ff5bee65ae26a519ceaa252b9cd25b627b0a4e67bdf543c2578a4543446e9d6da54a598689efa75a5aa2392bdab
9aaee416a9ae45aaa550b8cd6ded5abd61a8fb1b69e02a0a1a1a1a121401445948c0b0d05188c824c439712fd511dd653feaad7d6ee2f9de9380d709e32ba5a4
18d1926b422517234121f25abe8eaaa05251529a44a1c45125559fc3f1a14f9207ba24b6eafa3ef119fe677126bb557b8dc59c5bba2935557a06243004b6a5c6
6deaa7be6a7a30a167bda31bbeec49aa50226ee4b0377b96b35ef20113d1ba98e55741835c4e64e6c66cddc5b376e250ef7819e82fd4765ba1d086a55a5966d3
4c7730e19ddaecfd56353930864b54e20b2dbd1d2d257a2730395d5d66dea6f7e50a22773bb5d5ca3b46c550bf03c6ab579a3beba74a304355197b208b0677e6
b62b6b6b9a52af62fe09e2741a1a7d93584ac575947bba5b49702d8f4f544388ee63ae0777a6f0c977ce26ab34edabbad23d77f7e180abb1aa85b7b4a9eb39a8
205ab4bdda4d52176f6732d59adab090e325094127b9f6bc679ad29671c3255459abda1555dbca677da1a0012679bd44eadd11f69bafece38bb30522f6dc5d27
23bb6559f4aab860da63976331d8bbc7dd26d94966a4184b3f7beb85192a16e1c1c70a96a58ebb55d10cdc704b100b0c7850c770006f41000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
080894024ee60002705a0941a1a1a18714401144870cb1826d66b0bd9459c83d32dac930171b78db8eb42da6f7ba043a384d5ab2a36bd043f6484776d7588336
b086a93af626eae65b20bb8bd969ddda4a4945aa043f2af5c20347e46bb375542ceae2572fde4ba4f06f3ce3ce1648519eea355fddf64b45ea48f35593e0dc3a
4da25a30a96cb6d8a32506a67cfe2676bea7ba510d8ab1bea735ee03a443434343420f7c937c30b7850cca14a93575868d56b58409a67772dee2a30a8aae2dd5
959474189ee2eb0bd2f26ddddd4ad282fd5b4adaac5ca54e699be4e4d584755d9f57ba0d22daee84515ba033fa474d59aa84e648c56ee216da840118e5c34b0f
714912a65d4daa44d04154bab5d2a994f49227d644b5a41c6492592a82a82a82f49250ffab51a1a1a9dbbd9ab4e4dc14a69abcbeafeab9a5a4aae09bd5a048af
26f82434f9e5a6fb850024fb139100b9c71350d0d0d0cf062880220ad0c815aaabfb5daf65c50a2d63275563719658d955a59ad0c7d4f59b3ba5920ebd675323
03e54471214fdd197d4109804479a6a68a9c620abcd5f5aa8c67730f1173215f947d04944eabbea206cb5a255fea30ad0023ab24343434343420d35415a04e10
f7ba3598439fd84ba025a68a652f617758a68788c643c4d24c552ab19aea35d2824a89e6b3752b45743d1fda733be6ad9c7d2201aa6bb113414cb5735b9cad99
228daabe2be8fb5a5d342a643afe89232d5553575539ad49617ddd2fe84b4e0d3527a88fee67b5bd2d929b2d1784ace35727a851a34d695384ace14d55463ced
82189e6f79244b4467572f8a97ab058abdadd4946534343000d61100000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
080894024a770002705a0941a1a1a18714401144870cb1cbad84307fb9ddddca58485db4f9642b03f5c203fbc4bb367965f506afa25dceee6e657307549abeda
4f539b4045f5eb59aa65a6d71cc7196584b49cf9e5755500e16b243434343420f7c937c30b78504c5530b8ee830320a195012d195827c6a3272666611d4e0e2f
bef67cb8d755e02450ac79a19ead2fd55531bb62d2db4ae4b5a66387863a4aa85b62777719b3772266361450b58fc286554b00c4a4b59e2dec500e392a20d0d0
d0cf062880220ad0884e6cebc4fa27b86779688e89ab32f2887a257b6b181fbabeabab04ff10d55bdb2edddea58cf22675eac6d8d7d552716d4ab1a30ddb9ce3
796047da881bda520a3b1eaa0cb94e67b84ddd0484ea829bb3d60ab8b5322d610d609a38686868686840a7a82a418c30afd55420daad8e7ca3849356f457aa61
b2a1a1a6bce1c157557759f6553faa07dddaea4dd2ba1cac544b0b788284ba868505b5544519658435dfaaa4e5b9ddd098b5955757420fc936fd65a0e9fb2d9a
fe69da6dd578d5a4d5559fa4bc1cce419cde39c6d71b2e357eeee2d28820b50f82b8ae89985a7a1bd6daaa75eada42ea2a9cdaaec72b446d1f092a9ab2f3c46a
9c65d733b6bd9be5a4d5152347e9b878db89cd840dda22da00046040000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
080894024df40006836c9bc1678d10942d6e69feab35870afb117b6eea225cb0af97eb6d479e43fd0c2d85c105e374466221250a9ae1d94b5441c60e7ceddd45
fb9a5e9d840a72d6459a5f75dafa6450a871d7113019b00a2e34343434343430c369b12a194ae8cbdd9b5d0a59a928a6a29a35df6a2a1a1855774b0c3d0f9343
ab181a86dd8734586868e6afcaa0bb36f659db9ea57719bbaba4f5786868686868601254aa5e4f58b454aa19de6226730031f16101e711d206d22eb6cd0485f7
eb65302d6430ad6a8a920ac4d19aa0485aeaea6ade080dbd96b46ef2610f86090004b76000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
